# ADR-0008: Claude Code Web (gVisor) 環境向けのE2Eテスト設定の条件分岐

## ステータス

決定済み (2026-02-12)

## コンテキスト

Claude Code Web のリモート実行環境では、E2Eテスト（Playwright）が正常に動作しなかった。調査の結果、以下の2つの技術的制約が判明した。

### 1. Chromiumバイナリのバージョン不一致

環境にプリインストールされている Playwright ブラウザバイナリは chromium-1194（Playwright 1.56.x 対応）だが、プロジェクトの `@playwright/test` は v1.58.1（chromium-1208 が必要）だった。ネットワーク制限により新しいバイナリのダウンロードは不可能。

### 2. gVisor カーネルの syscall 制限

Claude Code Web は gVisor（`runsc`）カーネル上で動作している。gVisor は Linux カーネルの syscall をユーザースペースで再実装しているが、すべての syscall を完全にサポートしているわけではない。この制約により以下の問題が発生した。

- **ヘッドレスシェル（`headless_shell`）バイナリ**: ページ読み込み時にクラッシュ
- **フル Chromium バイナリ（通常のマルチプロセスモード）**: CDP (Chrome DevTools Protocol) の Input ドメインによるマウスクリック・キーボード入力イベントの送信時にレンダラープロセスがクラッシュ（`page.goto()` は成功するが `page.click()` や `page.type()` でクラッシュ）
- **`--single-process` フラグ**: 入力イベントの問題は解消するが、テスト間でブラウザコンテキストを閉じるとプロセス全体がクラッシュし、交互にテストが失敗する

最終的に `--no-zygote` フラグ（Chromium の Zygote プロセスフォーク機構を無効化）により、マルチプロセスモードを維持しつつ入力イベントも正常に動作することを確認した。

## 決定

`playwright.config.ts` において環境変数 `CLAUDE_CODE_REMOTE` の有無で Chromium の起動設定を条件分岐する。通常の環境ではデフォルト設定を使い、Claude Code Web 環境でのみ gVisor 向けの回避策を適用する。

また、`@playwright/test` はプリインストール済みバイナリに合わせて v1.56.1 に統一する。

## 理由

### 環境ごとにテスト設定を分岐させることの問題

テストは、どの環境でも同じ条件で実行されるのが理想である。環境依存の分岐をテスト設定に入れることには以下のリスクがある。

- **偽の安心**: 環境Aで通るが環境Bで落ちる（またはその逆の）テストが生まれうる
- **設定の複雑化**: 分岐が増えるほど、どの環境でどの設定が適用されるか把握しにくくなる
- **メンテナンスコスト**: gVisor やChromiumの更新により、回避策が不要になったり別の回避策が必要になる可能性がある

### それでもこの対応を行う理由

E2Eテストが全く実行できない状態は、テスト設定に環境分岐がある状態よりも悪い。Claude Code Web 上でコード変更を行う際にE2Eテストで品質を確認できないと、リグレッションを見逃すリスクが高まる。

今回の条件分岐は以下の点で限定的であり、許容範囲と判断した。

- **分岐は `playwright.config.ts` の1ファイルに閉じている**: テストコード自体は一切変更していない
- **テストの内容・検証項目は同一**: 変わるのは Chromium の起動方法のみ
- **環境検出は明示的な環境変数に基づく**: `CLAUDE_CODE_REMOTE=true` という意味論的に明確なシグナルを使用
- **将来の除去が容易**: `isClaudeCodeRemote` の条件分岐を削除すれば元に戻る

### 判断基準の適用

- **それがなくても目的は達成できないか？** → この対応がなければ Claude Code Web で E2E テストを実行できない。品質担保のために必要
- **説明なしで使い方がわかるか？** → 環境変数による自動検出のため、ユーザーの操作は不要
- **ユーザーの思考を中断させないか？** → 開発者がテスト実行時に環境差を意識する必要はない

## 影響

### 変更対象

- `playwright.config.ts`: `CLAUDE_CODE_REMOTE` 環境変数による Chromium 起動設定の条件分岐
- `package.json` / `package-lock.json`: `@playwright/test` を v1.56.1 に固定
- `.github/dependabot.yml`: Playwright 関連パッケージを自動更新の対象外に設定

### 関連コミット

- `f9f1696` — `@playwright/test` のダウングレードと gVisor 向け Chromium フラグの追加
- `4678f46` — `CLAUDE_CODE_REMOTE` 環境変数による自動切り替えへのリファクタリング

### 将来の対応

以下のいずれかの状況が発生した場合、この条件分岐は除去すべきである。

- **gVisor が Chromium の必要な syscall を完全サポートした場合**: 回避策自体が不要になる
- **Claude Code Web の実行環境が変わった場合**: 別の回避策が必要になるか、回避策が不要になる可能性がある
- **Playwright がこの問題に対する公式の対応を提供した場合**: Playwright 側の設定に移行する

除去する際は、以下の作業を行う。

1. `playwright.config.ts` から `isClaudeCodeRemote` に関連する条件分岐を削除し、`chromium` のインポートも不要なら除去する
2. `.github/dependabot.yml` の `ignore` セクションから `@playwright/test` のエントリを削除し、Dependabot による自動更新を再開する
3. `@playwright/test` を最新バージョンに更新し、`npx playwright install` でブラウザバイナリを取得する

## 代替案

### A. E2Eテストの実行を Claude Code Web では諦める

テスト設定に環境分岐を入れなくて済むが、E2Eテストによる品質確認が行えなくなる。CLAUDE.md のワークフロールール（コミット前に `npm run test:e2e` を実行する）に反する。不採用。

### B. テストコードを `dispatchEvent` ベースに書き換える

gVisor 環境では CDP の Input ドメインが動作しないため、`page.click()` の代わりに `page.locator().dispatchEvent('click')` を使う方法。テストコード自体を大幅に書き換える必要があり、テストの性質も変わってしまう（実際のユーザー操作のシミュレーションではなくなる）。不採用。

### C. `--single-process` フラグを使用する

入力イベントの問題は解消するが、テスト間でブラウザコンテキストを閉じるとプロセス全体がクラッシュし、毎回交互にテストが失敗する。リトライで回避は可能だが、テスト実行時間が大幅に増加する。不採用。
