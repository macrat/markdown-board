---
name: review-and-fix
description: code-reviewer と ux-reviewer による自動レビュー＆修正サイクル。両レビュアーにコードをレビューさせ、指摘事項をサブエージェントに修正させる。指摘が無くなるまで繰り返し実行する。コード変更後にプロアクティブに使用すること。
user_invocable: true
arguments:
  - name: scope
    description: レビュー範囲の指定（省略時はプロジェクト全体）
    required: false
---

# レビュー＆修正サイクル

このスキルは、code-reviewer と ux-reviewer にレビューを依頼し、検出された指摘事項をサブエージェントに修正させるワークフローです。指摘が無くなるまで繰り返し実行し、最後にクリーンなレビュー結果を確認して完了とします。

以下のステップを**必ず順番通りに**実行してください。

---

## レビュー範囲の決定

このスキルに引数が渡された場合、その内容に応じてレビュー範囲を決定してください。引数が渡されなかった場合は「プロジェクト全体」をレビューします。

### 引数のパターン

引数は自由記述です。以下は代表的なパターンですが、これ以外の指定にも柔軟に対応してください。

- **ブランチ差分**: 「mainブランチとの差分」「featureブランチの変更」など
  - `git diff main...HEAD --name-only` 等で変更ファイルの一覧を取得し、その一覧をレビュー対象とする
- **特定のファイルやディレクトリ**: 「components/Editor.tsx」「app/api/ 配下」など
  - 指定されたパスをそのままレビュー対象とする
- **特定の機能や関心事**: 「アーカイブ機能」「WebSocket同期」など
  - 該当する機能に関連するファイルを特定し、レビュー対象とする

### レビュー範囲テキストの組み立て

引数の内容に基づいて、以下の2つのテキストを組み立ててください。これらはステップ1でレビュアーへのプロンプトに埋め込まれます。

- **`{レビュー対象の説明}`**: レビュー対象を説明するテキスト（例: 「mainブランチからの変更内容」「components/Editor.tsx」「プロジェクト全体のコード」）
- **`{対象ファイルの指示}`**: レビュアーが読むべきファイルを具体的に指示するテキスト。以下のいずれかの形式にする:
  - 引数なしの場合: 空文字列（レビュアーがデフォルトの対象を読む）
  - ファイル一覧が確定している場合: `レビュー対象のファイル:\n- ファイルパス1\n- ファイルパス2\n- ...`
  - 機能やディレクトリの指定の場合: `レビュー対象: {指定された範囲の説明}`

---

## 作業開始前の準備: 未コミット変更のコミット

レビュー＆修正サイクルを開始する前に、`git status` で作業ディレクトリの状態を確認してください。**コミットされていない変更（ステージ済み・未ステージの両方）がある場合は、先にコミットしてからサイクルを開始してください。**

これにより、レビュー＆修正サイクルで行った変更と、それ以前の変更を明確に区別できるようになります。万が一サイクル中に問題が発生した場合にも、安全に巻き戻すことができます。

---

## ステップ1: レビューの実行

Task ツールを使って、以下の **2つのレビューエージェントを同時に（1つのメッセージで）** 起動してください。**必ず2つの Task ツール呼び出しを同一メッセージ内で行うこと。** 片方だけを起動してはいけません。

### エージェント1: code-reviewer

```
subagent_type: code-reviewer
```

以下のプロンプトで起動:

> {レビュー対象の説明}をレビューしてください。
> CLAUDE.md を読み、プロジェクトの哲学・原則・技術構成を把握した上で、バグ・可読性・メンテナンス性・セキュリティ・パフォーマンスの問題を検出してください。
> {対象ファイルの指示}
> 問題が見つからなかった場合は「コードに問題は見つかりませんでした」とだけ回答してください。

### エージェント2: ux-reviewer

```
subagent_type: ux-reviewer
```

以下のプロンプトで起動:

> {レビュー対象の説明}の UI/UX をレビューしてください。
> CLAUDE.md を読み、プロダクト哲学・5つのコア原則を把握した上で、ユーザー体験を損なう要素がないかを検証してください。
> {対象ファイルの指示}
> 問題が見つからなかった場合は「コードに問題は見つかりませんでした」とだけ回答してください。

---

## ステップ2: レビュー結果の確認

ステップ1で返ってきた2つのレビュー結果を確認してください。

### 修正対象の指摘が無い場合

以下のいずれかに該当する場合、**ステップ5（最終確認）**に進んでください:

- 両方のレビュアーから「コードに問題は見つかりませんでした」という回答が返ってきた場合
- 指摘はあるが、フィルタリングの結果すべてが「対応しない」と判断された場合（設計意図コメントの追加が必要なものがあれば、ステップ3でコメント追加のみ行ってからステップ5に進む）

### 指摘がある場合

検出された指摘事項を以下のように整理してください:

1. **重複の除去**: code-reviewer と ux-reviewer の指摘に重複がある場合はまとめる

2. **偽陽性の除外**（全重大度共通）: レビュアーの指摘が事実に基づいているかを検証する。ライブラリの API 仕様、言語仕様、実際のコードの挙動などを確認し、事実誤認に基づく指摘は除外する。除外した理由は最終レポートに記載する

3. **対応要否の判断**（後述の基準に従う）
4. **優先度順に整理**: Critical > Warning > Info の順に並べる
5. **修正単位にグルーピング**: 同じファイルや同じ機能に関する指摘をまとめて、修正しやすい単位にグルーピングする

#### 対応要否の判断基準

**Critical / Warning の指摘**: 原則としてすべて対応する。ただし以下に該当する場合は対応しないことができる:

- 現在のコードベースの規模・利用形態では実害がなく、修正による副作用リスクが利益を上回る場合
- CLAUDE.md の設計原則に基づき、現在の実装が意図的な設計判断である場合
- 対応しない場合は、その理由を明確に記録し、最終レポートに記載する

**Info の指摘**:

- CLAUDE.md のプロダクト哲学・ガイドラインに反する提案 → 対応しない
- 理論的なリスクのみで、現在のコードベースの規模・用途では実害がない指摘 → 対応しない
- 明確なメリットがあり、変更が小さい提案 → 対応する
- 対応しない場合は、その理由を最終レポートに記載する

### 対応しない指摘への設計意図コメント

指摘に対応しないと判断した場合、その理由が以下のいずれかに該当するときは、**該当箇所のコードに設計意図を説明するコメントを追加する**こと:

- **意図的な設計判断**: トレードオフを検討した結果、現在の設計が最適と判断した場合
- **レビュアーの誤検出**: レビュアーの前提が誤っており、指摘が実際には当てはまらない場合

コメントには以下の内容を簡潔に含めること:

1. **なぜこの設計にしているのか**（設計意図）
2. **トレードオフになっているものは何か**（代替案と、それを採用しなかった理由）
3. **どういう条件であれば見直すべきか**（該当する場合のみ）

例:

```typescript
// Ref lets findPage keep a stable identity (empty deps) while reading latest state.
// Using pages directly would cascade re-creation through every dependent useCallback.
const pagesRef = useRef<PageListItem[]>([]);
```

```typescript
// NEXT_PUBLIC_ prefix: single source of truth shared with the client (useCollabEditor.ts).
// A separate WS_PORT would risk port mismatch between client and server.
const PORT = process.env.NEXT_PUBLIC_WS_PORT || 1234;
```

これにより、将来のレビューで同じ指摘が繰り返されることを防ぎ、設計判断の経緯をコードに残すことができる。

**コメント追加不要なケース**:

- 言語やフレームワークの標準的なパターンであり、説明が不要な場合（例: `ReturnType<typeof setTimeout>` の型、ESLint準拠の依存配列）
- 指摘自体が非常に軽微で、再検出されても判断に迷わない場合

設計意図コメントの追加も TODO リストに含め、ステップ3でコード修正と同様にコミットすること。

### TODO リストの記録

整理した結果を TodoWrite ツールで TODO リストとして記録してください。修正する指摘と、設計意図コメントを追加する指摘の両方を含めること。

---

## ステップ3: 指摘事項の修正

ステップ2で整理した指摘事項を、グループごとにサブエージェントで修正します。

**独立したグループは並列に**、**依存関係があるグループは順番に**修正してください。

各グループの修正には Task ツール（`subagent_type: general-purpose`）を使い、以下の形式でプロンプトを渡してください:

> 以下のレビュー指摘事項を修正してください。
>
> 【指摘事項の内容をここに記載（ファイルパス、行番号、問題の説明、推奨される修正方法を含める）】
>
> 修正にあたっての注意:
>
> - CLAUDE.md のプロダクト哲学・開発ガイドラインに従うこと
> - 指摘された問題の修正に集中し、関係のないコードは変更しないこと
> - 修正後のコードがプロジェクトの既存のコーディングスタイルと一貫していること
> - 過剰な修正（不要なリファクタリング、コメント追加など）は行わないこと

修正が完了したら、各 TODO を完了としてマークしてください。

### lint と E2E テストの実行

修正が完了したら、以下のコマンドを順番に実行し、修正が既存の品質基準を満たしていることを確認してください:

```bash
npm run lint
npm run test:e2e
```

テストが失敗した場合は、失敗箇所を修正してから再度テストを実行し、すべて通るまで繰り返してください。

テストが環境の制約（ブラウザ未インストール、ネットワーク不通など）で実行できない場合は、実行可能なテスト（lint, unit test, build）のみで品質確認を行い、E2Eテストがスキップされた旨を最終レポートに記載してください。

### コミット

**1つの修正または改善を行うたびにコミットしてください。** すべての修正が終わるまでコミットを後回しにしてはいけません。修正 → テスト確認 → コミットの流れをグループごとに繰り返してください。

CLAUDE.md の「小さく独立したコミット」の原則に従い、性質の異なる修正は別々のコミットに分けてください。

---

## ステップ4: 再レビュー（ループ）

直前のレビュー（**ステップ1**）で検出された**すべての指摘に対する修正（ステップ3まで）が完了したら**、**ステップ1に戻って**再度レビューを実行してください。

ここでいう「ループ」とは、**ステップ1〜ステップ3の一連のサイクル**を指します。再レビュー（ステップ1）で新たな指摘が見つかった場合は、必ず再度 **ステップ2 → ステップ3** を実行し、そのサイクルを完了させてから、再びステップ1に戻ってください。

このステップ1〜3のループは、**指摘事項が無くなるまで繰り返し**ます。

**無限ループ防止**: ステップ1〜3のループは最大 **10回** までとします。10回目のレビュー（ステップ1）でまだ指摘がある場合は、残りの指摘事項を一覧にして報告し、ステップ5に進んでください。

### サイクル間の文脈の引き継ぎ

レビュアーは毎回新しいインスタンスとして起動されるため、前のサイクルの判断を知らない。2回目以降のステップ1では、以下の情報をレビュアーへのプロンプトに追加すること:

> 以下の指摘は前回のレビューサイクルで検出済みであり、検討の結果対応不要と判断されています。これらと同一の指摘は報告しないでください。
>
> - {対応しない指摘1: ファイルパスと概要}
> - {対応しない指摘2: ファイルパスと概要}
> - ...

これにより、レビュアーが同じ指摘を繰り返すことを防ぎ、サイクルの収束を早める。

### 予想外の事態が起きた場合

改善サイクルの中で、テストが突然壊れた、修正が意図しない副作用を生んだ、ファイルの状態が想定と異なるなど、**予想外の事態が発生した場合**は、以下の手順で対処してください:

1. **コミットログを確認する**: `git log --oneline` でサイクル中の変更履歴を確認し、どの修正が問題を引き起こしたかを特定する
2. **差分を確認する**: `git diff` や `git show <commit>` で問題のある変更の内容を把握する
3. **必要に応じて巻き戻す**: 問題を引き起こしたコミットが特定できた場合は、`git revert <commit>` で該当コミットを巻き戻し、正しい方法で再度修正を行う

作業開始前の準備ステップとステップ3で細かくコミットしているため、問題の特定と巻き戻しが容易にできるはずです。**推測で修正を重ねるのではなく、まずコミットログから事実を把握すること**を優先してください。

---

## ステップ5: 最終確認

### 最終レビューの実行

ステップ1と同じ方法で、code-reviewer と ux-reviewer を**同時に**起動し、最終レビューを実行してください。

### 結果の報告

最終レビューの結果に基づいて、以下のサマリーを出力してください:

```
## レビュー＆修正サイクル完了

### サマリー

- **実行回数**: N回のレビュー＆修正サイクルを実行
- **検出した指摘の総数**: X件（Critical: A件、Warning: B件、Info: C件）
- **修正した指摘の数**: Y件
- **残存する指摘**: Z件（ある場合は詳細を記載）

### 修正内容

- 修正1の概要
- 修正2の概要
- ...

### 最終レビュー結果

[最終レビューの結果をここに記載]
```
